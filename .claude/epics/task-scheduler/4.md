---
name: Worker Capacity Tracking
status: closed
created: 2026-01-17T09:00:24Z
updated: 2026-01-17T09:08:42Z
github: https://github.com/ebergstedt/ccpm-poc/issues/4
last_sync: 2026-01-17T10:09:08Z
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Worker Capacity Tracking

## Description

Implement real-time worker capacity tracking by subscribing to worker heartbeat events via gRPC. The WorkerRegistry maintains current load, queue depth, and availability estimates for each worker.

## Acceptance Criteria

- [ ] Subscribe to worker heartbeat gRPC stream
- [ ] Update WorkerState on each heartbeat
- [ ] Track: currentLoad, queueDepth, lastHeartbeat
- [ ] Calculate estimatedAvailableAt based on queue depth
- [ ] Mark workers as unhealthy after heartbeat timeout (30s)
- [ ] Remove workers that haven't sent heartbeat in 5 minutes
- [ ] Emit events when worker state changes significantly

## Technical Details

### Files to Create/Modify
- `src/scheduler/registry/worker-registry.ts` - Extend with capacity tracking
- `src/scheduler/registry/heartbeat-subscriber.ts` - gRPC subscription
- `src/scheduler/registry/availability-calculator.ts` - Availability estimates

### Worker Heartbeat Proto (expected from workers)
```protobuf
message WorkerHeartbeat {
  string worker_id = 1;
  float cpu_usage = 2;      // 0-1
  float memory_usage = 3;   // 0-1
  int32 queue_depth = 4;
  int64 timestamp_ms = 5;
}
```

### Availability Calculation
```typescript
// Estimated time until worker is available
estimatedAvailableAt = now + (queueDepth * avgTaskDuration);

// Current load is weighted average of CPU and memory
currentLoad = 0.6 * cpuUsage + 0.4 * memoryUsage;
```

### Health States
- `healthy`: Heartbeat within 30s, load < 0.9
- `degraded`: Heartbeat within 30s, load >= 0.9
- `unhealthy`: No heartbeat for 30s
- `removed`: No heartbeat for 5 minutes (purged from registry)

## Dependencies

- [ ] Task 2: Core Scheduler Framework (WorkerRegistry base)
- [ ] Worker gRPC heartbeat stream available

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: true (can start after 2, parallel with 3)

## Definition of Done

- [ ] Code implemented
- [ ] Unit tests for availability calculation and health transitions
- [ ] Integration test with mock gRPC stream
- [ ] Workers marked unhealthy after timeout
- [ ] Code reviewed
