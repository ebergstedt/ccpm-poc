---
name: Metrics & Observability
status: closed
created: 2026-01-17T09:00:24Z
updated: 2026-01-17T09:08:42Z
github: https://github.com/ebergstedt/ccpm-poc/issues/6
last_sync: 2026-01-17T10:09:08Z
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Metrics & Observability

## Description

Implement comprehensive observability for the scheduler: ClickHouse integration for decision logging, Prometheus metrics export, and structured logging. Every scheduling decision should be traceable and queryable.

## Acceptance Criteria

- [ ] ClickHouse schema for scheduling decisions
- [ ] Log every decision with full context (task, worker, score, reasoning)
- [ ] Prometheus metrics: decisions/sec, latency histogram, prediction accuracy
- [ ] Structured JSON logging with correlation IDs
- [ ] Query interface for decision replay/debugging
- [ ] Metrics endpoint exposed at `/metrics`

## Technical Details

### Files to Create
- `src/scheduler/metrics/prometheus.ts` - Prometheus client setup
- `src/scheduler/metrics/clickhouse.ts` - ClickHouse writer
- `src/scheduler/metrics/decision-logger.ts` - Decision audit logging

### ClickHouse Schema
```sql
CREATE TABLE scheduler_decisions (
  timestamp DateTime64(3),
  task_id String,
  task_type String,
  worker_id String,
  predicted_duration_ms UInt32,
  predicted_wait_ms UInt32,
  score Float32,
  reasoning String,
  fallback_used UInt8
) ENGINE = MergeTree()
ORDER BY (timestamp, task_id);
```

### Prometheus Metrics
```typescript
// Counter: Total scheduling decisions
scheduler_decisions_total{status="success|fallback|error"}

// Histogram: Scheduling latency
scheduler_decision_latency_ms{quantile="0.5|0.9|0.99"}

// Gauge: Active workers
scheduler_workers_active{status="healthy|degraded|unhealthy"}

// Histogram: Prediction accuracy (predicted/actual ratio)
scheduler_prediction_accuracy_ratio
```

### Structured Log Format
```json
{
  "level": "info",
  "timestamp": "2026-01-17T09:00:00Z",
  "correlationId": "task-123",
  "event": "scheduling_decision",
  "taskId": "task-123",
  "workerId": "worker-5",
  "score": 0.85,
  "latencyMs": 3
}
```

## Dependencies

- [ ] Task 2: Core Scheduler Framework (service structure)
- [ ] ClickHouse available
- [ ] Prometheus scrape configured

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: true (can proceed after 2, independent of 3-5)

## Definition of Done

- [ ] Code implemented
- [ ] ClickHouse schema deployed
- [ ] Metrics visible in Prometheus
- [ ] Sample queries for decision debugging documented
- [ ] Code reviewed
