---
name: Feedback Loop
status: closed
created: 2026-01-17T09:00:24Z
updated: 2026-01-17T09:08:42Z
github: https://github.com/ebergstedt/ccpm-poc/issues/7
last_sync: 2026-01-17T10:09:08Z
depends_on: [3, 5]
parallel: false
conflicts_with: []
---

# Task: Feedback Loop

## Description

Implement the feedback mechanism that captures actual task execution times and updates predictions accordingly. This enables continuous learning and drift detection for the heuristic predictor.

## Acceptance Criteria

- [ ] Subscribe to task completion events
- [ ] Update predictor with actual execution duration
- [ ] Detect prediction drift (actual differs >50% from predicted)
- [ ] Log drift warnings for investigation
- [ ] Track prediction accuracy over time (rolling window)
- [ ] Emit accuracy metrics to Prometheus

## Technical Details

### Files to Create
- `src/scheduler/feedback/completion-subscriber.ts` - Task completion listener
- `src/scheduler/feedback/drift-detector.ts` - Drift detection logic
- `src/scheduler/feedback/accuracy-tracker.ts` - Rolling accuracy stats

### Completion Event (from workers)
```typescript
interface TaskCompletion {
  taskId: string;
  taskType: string;
  workerId: string;
  startedAt: Date;
  completedAt: Date;
  durationMs: number;
  success: boolean;
}
```

### Drift Detection
```typescript
function detectDrift(predicted: number, actual: number): boolean {
  const ratio = actual / predicted;
  return ratio < 0.5 || ratio > 2.0; // >2x deviation = drift
}
```

### Accuracy Tracking
```typescript
interface AccuracyWindow {
  windowSize: number; // Default: 1000 samples
  withinThreshold: number; // Count within 25% of actual
  total: number;
  accuracy: number; // withinThreshold / total
}
```

### Integration Flow
```
Task Completed → Completion Subscriber
                      ↓
              Drift Detector (log if drift)
                      ↓
              Predictor.update(taskType, actualDuration)
                      ↓
              Accuracy Tracker (update rolling stats)
                      ↓
              Prometheus (export accuracy metric)
```

## Dependencies

- [ ] Task 3: Heuristic Predictor (update method)
- [ ] Task 5: Multi-Objective Scorer (scheduling happens first)
- [ ] Task completion events available from workers

## Effort Estimate

- Size: S
- Hours: 4-6
- Parallel: false (depends on 3 and 5)

## Definition of Done

- [ ] Code implemented
- [ ] Unit tests for drift detection and accuracy calculation
- [ ] Integration test: completion → prediction update flow
- [ ] Drift logged when thresholds exceeded
- [ ] Code reviewed
